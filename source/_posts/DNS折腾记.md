---
title: DNS折腾记
date: 2017-04-30 00:04:29
updated:
tags:
- DNS
- hosts
- dnsmasq
- ss
categories:
- DNS
keywords:
description:
---

# 前言
一直使用人家开源的[hosts][1]替换笔记本上的或者Android 手机上的文件, 但是又不免遇到几个问题![idea][2]

 1. 每次都要执行两种替换，电脑和手机上的
 2. Android 手机 hosts 文件的换行符必须是 `\ n` 而不是 windows 的 `\ r\n`，电脑直接替换，但在对安卓hosts文件替换之前必须在电脑端对文件加工


 

``` stylus
 用 Notepad++ 打开 hosts 文件 
 点击菜单中的视图–显示符号–显示所有字符”
 将所有 "CR LF" 的换行符换成 "LF "
```
 3. 未 root 的 Android 手机和未越狱的 IOS 设备无法修改 hosts 文件
这就很卧槽了![草泥马.jpg][3]，难道我改个 DNS 记录还要去承担 root  和越狱的未知风险么，于是情节开始有了发展![捣蒜.gif][4]
# 进入主线
寻思着从身边的东西下手解决需求，路由器———就是你了嘿嘿![藐视.jpg][5]
路由器的型号是极路由二，既然主打智能就应该能用来完成 DNS 解析，再瞅瞅插件，发现彩蛋一枚
![极路由自定义hosts1.jpg][6]
安装下来看看详情页面
![极路由自定义hosts2.jpg][7]，这程序猿还是挺懂人心的，预置了不少域名. 看看使用说明，发现个最大问题———支持条目太少，为什么会这样呢，再去瞅瞅路由器参数
![极路由参数.jpg][8]这参数我给8分，满点100. 不管了先搞搞先![enter description here][9]
首先确认好流程，极路底层系统从 LINUX 开发，那么我必须先处理好换行符，然后把全部记录一次性复制进去——插件提示超过限制![疑问.jpg][10]，一定是哪里搞错了，
首先试着把空白行删除再复制——还是超出限制![疑问.jpg][11]
我服，我把注释删掉好了

``` stylus
匹配 # 字符删除所在行
```
复制进去，![喝茶.jpg][12]等插件下载进度慢慢跑完，boom，改一下手机的 DNS 到路由器地址，可以用，真是皆大欢喜![哈哈哈.jpg][13]
再偷懒一点，用 winscp 进入路由器`etc` 目录找到 hosts 文件，直接将仅执行换行的记录文本复制进去，重启下路由器，测试一下，貌似工作正常，再进去查看下文件，简直了——直接少了一半的记录，我还是选择插件大法吧——停，好像这跟我的出发点不太一样，为什么我想要偷懒反而变得复杂了![embarrassed.jpg][14]
总之先问问度娘可行的替代方法~
先逛逛极路由官方论坛，简直了，hosts 修改全是吐槽难用的，然后下边给出的解决方法是换个360路由——我 Dr.com 认证就是用修改版极路由做的，不干——主要是懒癌![wall-lay.gif][15]
事到如今我只能祭出杀手锏了——腾讯云上边的主机，要不我自建个 DNS 服务器吧


----------


# 主线二号 

服务器上跑的是CentOs系统，这下有搞头![扇扇子.jpg][16]，找找可选方案，java环境?玩不开，滚蛋. python环境？还是玩不开，滚犊子. 捕捉到一个特别的——DNSmasq，原生方案，高度可定制
![眼神犀利.jpg][17]，就是你了. 下边全程使用winscp跟putty软件. 
找到`dnsmasq-conf`文件，参照网上各种不负责任复制粘贴的博客内容，翻译一下文件指引，开始搞事![羞羞.jpg][18]
先写好基础的配置

``` stylus
no-resolv  //不使用/etc/resolv.conf指定上游 DNS 服务器，直接下方给出
server=119.29.29.29
server=114.114.114.114  //上游服务器选用了腾讯和114
server=/.edu.cn/222.200.115.251 //针对校园网内访问使用校内 DNS 
server=/google.com/139.x.x.x //避免谷歌用自己的dns重定向，强制转向自己的服务器地址
addn-hosts=/etc/dnsmasq.host //挂载hosts文件

```
`dnsmasq-conf`文件中还可加入特别的解析地址和广告屏蔽，比如我就为了日服fgo 加入了如下配置

``` lsl
address=/data.fate-go.jp/54.230.249.7
address=/view.fate-go.jp/54.192.75.120
address=/ocsp.digicert.com/117.18.237.29
```
当然上边的地址不知道什么时候会失效. 获得主机名的方法是用shadowscks记录 DNS 记录，这里不展开写
然后怎么可能少了 `hosts` 文件呢，替换好行尾符后复制到`/etc/dnsmasq.host`文件中.
打开putty 连接终端输入` sudo service dnsmasq restart `重启服务，再输入` 
netstat -tunlp|grep 53 `测试53端口，正常的话应该跟下边差不多

``` x86asm
[root@VM_27_70_centos ~]# netstat -tunlp|grep 53
tcp        0      0 0.0.0.0:53                  0.0.0.0:*                   LIST                    EN      4226/dnsmasq
udp        0      0 0.0.0.0:53                  0.0.0.0:*                                                   4226/dnsmasq
```
然后修改本地 DNS 地址,
本机 cmd 指令 ` ipconfig /flushdns `, 打开谷歌应用商店，正常显示内容![啊呀呀.gif][19]，真是太愉快了
咳咳，都说人的欲望是满足不了的，到这里我又有了一个奇特的脑洞，想办法让没越狱的 IOS 设备用上这个 DNS ![喝水.jpg][20]但是难度貌似挺大，毕竟网上都没有正确的解决方法，也许我该找找特定的工具——绕道？照着这个思路，剧情逐步走向了升华


----------


# 剧情升华
翻山越岭仍未找到合适的方式，在课上的百无聊赖的我为了肝 fgo 地打开了 shadowsocks，连接上了国外的代理，然后一个激灵果断上网查找 SS 客户端的工作原理，详细过程不做描述，网上各种复制粘贴，请让我这个表情![diu.jpg][21]表达对这些博客主的敬意，之后仅在 wiki 站点找到了数量极少的说明，然后打开了客户端自带的配置文件`default.db.conf`
默认的内容如下(仅截图了代表性的部分)

``` stylus
# Shadowrocket: 2017-04-30 02:03:21
[General]
bypass-system = true
skip-proxy = 192.168.0.0/16,10.0.0.0/8,172.16.0.0/12,localhost,*.local,e.crashlynatics.com
bypass-tun = 0.0.0.0/8,1.0.0.0/9,1.160.0.0/11,1.192.0.0/11,10.0.0.0/8,14.0.0.0/11,14.96.0.0/11,14.128.0.0/11,14.192.0.0/11,27.0.0.0/10,27.96.0.0/11,27.128.0.0/9,36.0.0.0/10,36.96.0.0/11,36.128.0.0/9,39.0.0.0/11,39.64.0.0/10,39.128.0.0/10,42.0.0.0/8,43.224.0.0/11,45.64.0.0/10,47.64.0.0/10,49.0.0.0/9,49.128.0.0/11,49.192.0.0/10,54.192.0.0/11,54.191.0.0/16,58.0.0.0/9,58.128.0.0/11,58.192.0.0/10,59.32.0.0/11,59.64.0.0/10,59.128.0.0/9,60.0.0.0/10,60.160.0.0/11,60.192.0.0/10,61.0.0.0/10,61.64.0.0/11,61.128.0.0/10,61.224.0.0/11,100.64.0.0/10,101.0.0.0/9,101.128.0.0/11,101.192.0.0/10,103.0.0.0/10,103.192.0.0/10,106.0.0.0/9,106.224.0.0/11,110.0.0.0/7,112.0.0.0/9,112.128.0.0/11,112.192.0.0/10,113.0.0.0/9,113.128.0.0/11,113.192.0.0/10,114.0.0.0/9,114.128.0.0/11,114.192.0.0/10,115.0.0.0/8,116.0.0.0/8,117.0.0.0/9,117.128.0.0/10,118.0.0.0/11,118.64.0.0/10,118.128.0.0/9,119.0.0.0/9,119.128.0.0/10,119.224.0.0/11,120.0.0.0/10,120.64.0.0/11,120.128.0.0/11,120.192.0.0/10,120.198.201.0/24,121.0.0.0/9,121.192.0.0/10,122.0.0.0/7,124.0.0.0/8,125.0.0.0/9,125.160.0.0/11,125.192.0.0/10,127.0.0.0/8,139.0.0.0/11,139.128.0.0/9,140.64.0.0/11,140.128.0.0/11,140.192.0.0/10,144.0.0.0/10,144.96.0.0/11,144.224.0.0/11,150.0.0.0/11,150.96.0.0/11,150.128.0.0/11,150.192.0.0/10,152.96.0.0/11,153.0.0.0/10,153.96.0.0/11,157.0.0.0/10,157.96.0.0/11,157.128.0.0/11,157.224.0.0/11,159.224.0.0/11,161.192.0.0/11,162.96.0.0/11,163.0.0.0/10,163.96.0.0/11,163.128.0.0/10,163.192.0.0/11,166.96.0.0/11,167.128.0.0/10,167.192.0.0/11,168.160.0.0/11,169.254.0.0/16,171.0.0.0/9,171.192.0.0/11,172.16.0.0/12,175.0.0.0/9,175.128.0.0/10,180.64.0.0/10,180.128.0.0/9,182.0.0.0/8,183.0.0.0/10,183.64.0.0/11,183.128.0.0/9,192.0.0.0/24,192.0.2.0/24,192.88.99.0/24,192.96.0.0/11,192.160.0.0/11,198.18.0.0/15,198.51.100.0/24,202.0.0.0/9,202.128.0.0/10,202.192.0.0/11,203.0.0.0/9,203.128.0.0/10,203.192.0.0/11,210.0.0.0/10,210.64.0.0/11,210.160.0.0/11,210.192.0.0/11,211.64.0.0/10,211.128.0.0/10,218.0.0.0/9,218.160.0.0/11,218.192.0.0/10,219.64.0.0/11,219.128.0.0/11,219.192.0.0/10,220.96.0.0/11,220.128.0.0/9,221.0.0.0/11,221.96.0.0/11,221.128.0.0/9,222.0.0.0/8,223.0.0.0/11,223.64.0.0/10,223.128.0.0/9
dns-server = 114.114.114.114,119.29.29.29,8.8.8.8 
[Rule]
DOMAIN-KEYWORD,google,PROXY,force-remote-dns
DOMAIN-KEYWORD,facebook,PROXY,force-remote-dns
DOMAIN-KEYWORD,gmail,PROXY,force-remote-dns
DOMAIN-SUFFIX,twimg.com,PROXY,force-remote-dns
DOMAIN-SUFFIX,admob.com,REJECT

DOMAIN-SUFFIX,adview.cn,REJECT
DOMAIN-SUFFIX,adwhirl.com,REJECT
DOMAIN-SUFFIX,adwo.com,REJECT
DOMAIN-SUFFIX,cnzz.com,DIRECT
DOMAIN-SUFFIX,mzstatic.com,PROXY
DOMAIN-SUFFIX,appspot.com,PROXY
DOMAIN-SUFFIX,ykimg.com,DIRECT
DOMAIN-SUFFIX,medium.com,PROXY
DOMAIN-SUFFIX,clashroyaleapp.com,DIRECT
DOMAIN-SUFFIX,bilibili.com,DIRECT
DOMAIN-SUFFIX,bilibili.cn,DIRECT
DOMAIN-SUFFIX,acgvideo.com,DIRECT
DOMAIN-SUFFIX,outlook.com,DIRECT
IP-CIDR,91.108.56.0/22,PROXY
IP-CIDR,91.108.4.0/22,PROXY
IP-CIDR,109.239.140.0/24,PROXY
IP-CIDR,149.154.160.0/20,PROXY
IP-CIDR,192.168.0.0/16,DIRECT
IP-CIDR,10.0.0.0/8,DIRECT
IP-CIDR,172.16.0.0/12,DIRECT
IP-CIDR,127.0.0.0/8,DIRECT
GEOIP,CN,DIRECT
FINAL,PROXY

```
上边有几处需要特别注意的

 1. ` dns-server = 114.114.114.114,119.29.29.29,8.8.8.8  ` //指定dns服务器？
 2. `GEOIP,CN,DIRECT ` //中国域名使用直连方式？
 3. `FINAL,PROXY `  //其他不在表中的使用代理？

带着疑问我执行了以下步骤，

 1. 打开 shaowsocks 的流量统计日志,使用预设配置，打开国内百度首页，载入网页后回到软件统计页面，页面数据是**代理流量0 K，直连流量 15K**，关闭 ss 连接，这里十分重要
 2. 打开 ss 连接，打开谷歌相册app，载入一个图片后回到软件统计页面，页面数据是**代理流量50K，直连流量 0 K**，关闭 ss 连接，这里十分重要
 3. 初步判断第二点是正确的
 4. 打开 ss 连接，打开上边未包括在标志 `DIRECT`行中 的站点，载入网页后回到软件统计页面，页面数据是**代理流量25 K，直连流量 0K**，这里十分重要
 5. 继续判断第三点是正确的
 6. 下载并将列表中 `PROXY`替换成 `DIRECT`,删去`force-remote-dns`语句，并设置为ss 的使用配置文件
 7. 打开 ss 连接，打开上边未包括在标志 `DIRECT`行中 的站点，载入网页后回到软件统计页面，页面数据是**代理流量0 K，直连流量  25K**，这里十分重要
 8. 更加坚信第三点的正确，同时也产生了一个疑惑——` dns-server =` 行是否依赖于 ss 服务器的连接状态(生效与否)
 9. 于是我连接上了一个客户端中显示超时的 ss 服务器，手机显示 VPN 其实与服务器连接失败，我设想应该是软件 api 模拟出来的连接状态，并被手机接收
 10. 接着打开上边未包括在标志 `DIRECT`行中 的站点，载入网页后回到软件统计页面，页面数据是**代理流量0 K，直连流量  25K**

细心人可能就会发现我找到了突破口，![嘿嘿.jpg][22]没错就是` dns-server =`行，于是
 11. 我在这里填上了自己的 DNS 服务器地址，接上失效的 SS 服务器，打开了谷歌站点，回到软件统计页面，页面数据是**代理流量0 K，直连流量  26 k**
我特么终于解决温饱需求了![拍肩.gif][23]，至此为 未root Android 手机和 未越狱 IOS 设备 提供自定义 DNS 的需求得到了完美解决，你问我翻墙是不是想做一些羞羞的见不得人的事情，我只能送你这个表情了![enter description here][24]


----------


# 后记
关于 shaowsocks 的账号，可以在主机上搭建，参见我另一篇文章" Shadowsocks服务器端的搭建 ",对了你也许需要一个主机，这里是给学生党的经济选择 “[腾讯云云+校园计划][25]” “[阿里云云翼计划][26]”
起初一个很平常微小的需求被我放大到了进行 DNS 服务搭建才能满足的地步，不过在这过程中我学到了不少的东西，当然这些知识可能不太见得了光，但无论如何，有收获就是好的![OK.jpg][27]
最后来个告别：祝大家撸得愉快![告辞.jpg][28]




  [1]: https://github.com/DonQvixote/GoogleHosts.git
  [2]: DNS折腾记/idea.gif
  [3]: DNS折腾记/草泥马.jpg
  [4]: DNS折腾记/捣蒜.gif
  [5]: DNS折腾记/藐视.jpg
  [6]: DNS折腾记/极路由自定义hosts1.jpg
  [7]: DNS折腾记/极路由自定义hosts2.jpg
  [8]: DNS折腾记/极路由参数.jpg
  [9]: DNS折腾记/bamp.gif
  [10]: DNS折腾记/疑问.jpg
  [11]: DNS折腾记/疑问.jpg
  [12]: DNS折腾记/喝茶.jpg
  [13]: DNS折腾记/哈哈哈.jpg
  [14]: DNS折腾记/embarrassed.jpg
  [15]: DNS折腾记/wall-lay.gif
  [16]: DNS折腾记/扇扇子.jpg
  [17]: DNS折腾记/眼神犀利.jpg
  [18]: DNS折腾记/羞羞.jpg
  [19]: DNS折腾记/啊呀呀.gif
  [20]: DNS折腾记/喝水.jpg
  [21]: DNS折腾记/diu.jpg
  [22]: DNS折腾记/嘿嘿.jpg
  [23]: DNS折腾记/拍肩.gif
  [24]: DNS折腾记/yellow.gif
  [25]: https://www.qcloud.com/act/campus
  [26]: https://promotion.aliyun.com/ntms/campus2017.html
  [27]: DNS折腾记/OK.jpg
  [28]: DNS折腾记/告辞.jpg